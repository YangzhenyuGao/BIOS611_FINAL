---
title: "Evaluation of Prognostic Determinants and Survival Outcomes in Breast Carcinoma"
author: "Yangzhenyu Gao"
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    toc_depth: '3'
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
    theme: cosmo
    highlight: tango
    code_folding: show
subtitle: "A Comprehensive Analysis of SEER Data (2006-2010)"
---

```{r setup, include=FALSE}
# Global options for knitr
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width=10, fig.height=6)
```

# 1. Introduction & Setup

This analysis investigates a cohort of 4,024 breast cancer patients to answer three key scientific questions regarding socio-demographic disparities, predictors of lymph node metastasis, and age-related biological profiles.

## 1.1 Load Libraries

```{r}
# Load necessary packages
library(tidyverse)
library(survival)
library(survminer)
library(corrplot)
library(caret)
library(randomForest)
library(janitor)
library(pROC)
library(gtsummary)
library(gridExtra)

# Set a seed for reproducibility
set.seed(42)
```

## 1.2 Data Preparation and Cleaning

Loading the dataset from the specified local path.

```{r}
# Define the file path (Using forward slashes for R compatibility)
file_path <- "C:/HISTORY/4_PhD_UNC/HWK/BIOS611_final/data/Breast_Cancer.csv"

# Load Data
raw_df <- read.csv(file_path, stringsAsFactors = FALSE)

# Preprocessing pipeline
df_clean <- raw_df %>%
  rename(
    # Standardize names for easier coding
    Age = Age,
    Race = Race,
    Marital_Status = Marital.Status,
    T_Stage = T.Stage,
    N_Stage = N.Stage,
    Stage_6th = X6th.Stage,
    Differentiation = differentiate,
    Grade = Grade,
    A_Stage = A.Stage,
    Tumor_Size = Tumor.Size,
    Estrogen_Status = Estrogen.Status,
    Progesterone_Status = Progesterone.Status,
    Nodes_Examined = Regional.Node.Examined,
    Nodes_Positive = Reginol.Node.Positive, # Fixed typo in CSV header
    Survival_Months = Survival.Months,
    Status = Status
  ) %>%
  mutate(
    # 1. Create Binary Status for ML and Survival Analysis (Dead = Event = 1)
    Status_Binary = ifelse(Status == "Dead", 1, 0),
    
    # 2. Define "Advanced Stage" for Demographic Analysis (Stage III as Advanced)
    # Note: Dataset contains IIA, IIB, IIIA, IIIB, IIIC. We group III as Advanced.
    Is_Advanced_Stage = ifelse(grepl("III", Stage_6th), "Advanced (Stage III)", "Early/Mid (Stage II)"),
    Is_Advanced_Stage = factor(Is_Advanced_Stage, levels = c("Early/Mid (Stage II)", "Advanced (Stage III)")),
    
    # 3. Factor Conversion
    Race = as.factor(Race),
    Marital_Status = as.factor(Marital_Status),
    T_Stage = as.factor(T_Stage),
    N_Stage = as.factor(N_Stage),
    Stage_6th = as.factor(Stage_6th),
    Grade = as.factor(Grade),
    Differentiation = as.factor(Differentiation),
    Estrogen_Status = as.factor(Estrogen_Status),
    Progesterone_Status = as.factor(Progesterone_Status),
    Status = factor(Status, levels = c("Alive", "Dead")) # Factor for Classification
  )

# Preview the cleaned data structure
glimpse(df_clean)

```

## 1.3.1 Exploratory Data Analysis - Demographic Summary

Overview of the cohort characteristics.

```{r}
df_clean %>%
  select(Age, Race, Marital_Status, T_Stage, Grade, Status_Binary) %>%
  tbl_summary(by = Status_Binary) %>%
  add_p() %>%
  bold_labels()
```

## 1.3.2 Exploratory Data Analysis - Correlation Analysis

Checking for multicollinearity among continuous variables.

```{r}
# Select numeric columns for correlation
numeric_vars <- df_clean %>%
  select(Age, Tumor_Size, Nodes_Examined, Nodes_Positive, Survival_Months)

cor_matrix <- cor(numeric_vars)
corrplot(cor_matrix, method = "color", type = "upper", 
         addCoef.col = "black", tl.col = "black", diag = FALSE,
         title = "Correlation Matrix of Continuous Variables", mar=c(0,0,2,0))
```


# 2. Research Question 1: Determinants of Overall Survival

**Scientific Question:** Which clinical and pathological factors are significantly associated with overall survival? specifically, do factors like Tumor Stage, Grade, and Hormone Status independently predict mortality hazard?

## 2.1 Kaplan-Meier Survival Analysis

We first visualize univariate survival curves stratified by Cancer Stage.

```{r}
# Survival Object
surv_obj <- Surv(time = df_clean$Survival_Months, event = df_clean$Status_Binary)

# KM Plot by Race
fit_race <- survfit(surv_obj ~ Race, data = df_clean)

ggsurvplot(fit_race, data = df_clean,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, palette = "jco",
  ggtheme = theme_minimal(),
  title = "Overall Survival by Race",
  xlab = "Time (Months)",
  ylab = "Survival Probability",
  legend.labs = levels(df_clean$Race))

# KM Plot by Marital Status
fit_marital <- survfit(surv_obj ~ Marital_Status, data = df_clean)

ggsurvplot(fit_marital, data = df_clean,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, palette = "jco",
  ggtheme = theme_minimal(),
  title = "Overall Survival by Marital Status",
  xlab = "Time (Months)",
  ylab = "Survival Probability",
  legend.labs = levels(df_clean$Marital_Status))

# KM Plot by Breast Cancer Stage
fit_stage <- survfit(surv_obj ~ Stage_6th, data = df_clean)

ggsurvplot(fit_stage, data = df_clean,
  pval = TRUE, conf.int = TRUE,
  risk.table = TRUE, palette = "jco",
  ggtheme = theme_minimal(),
  title = "Overall Survival by Cancer Stage",
  xlab = "Time (Months)",
  ylab = "Survival Probability",
  legend.labs = levels(df_clean$Stage_6th))

```

## 2.2 Multivariate Cox Proportional Hazards Model
We adjust for clinical confounders (T-stage, Grade, Age, Estrogen Status) to isolate the effect of Race and Marital Status.

```{r}
# Cox Model including key clinical variables
cox_model <- coxph(surv_obj ~ Age + Race + Marital_Status + Stage_6th + 
                     Grade + Tumor_Size + Estrogen_Status + Progesterone_Status, 
                   data = df_clean)

# Visualize Hazard Ratios using a Forest Plot
ggforest(cox_model, data = df_clean, main = "Hazard Ratios for Mortality Risk")

# Summary of the model
summary(cox_model)

# Print detailed summary table
tbl_regression(cox_model, exponentiate = TRUE) %>%
  bold_p() %>%
  as_gt() %>%
  gt::tab_header(title = "Multivariate Cox Regression Results")

```

**Interpretation:** 

1. The Hierarchy of Risk: Our multivariate Cox Proportional Hazards model confirmed that Cancer Stage and Regional Node Positivity are the dominant drivers of mortality risk. As observed in the forest plot and regression tables, patients with Stage IIIC disease face a significantly higher hazard of death compared to those with Stage IIA, validating the TNM staging system's prognostic power.

2. The Protective Role of Hormones: Consistent with established oncology literature, Estrogen (ER) and Progesterone (PR) positive status were identified as strong protective factors (Hazard Ratio < 1). This confirms that patients with hormone-receptor-positive tumors have better survival outcomes, likely due to the availability of targeted endocrine therapies (e.g., Tamoxifen or Aromatase Inhibitors) and generally less aggressive tumor biology.

3. Tumor Grade: Higher tumor grade (Poorly differentiated) was independently associated with worse survival, emphasizing that cellular aggressiveness remains a key prognosticator even when controlling for stage.

# 3. Research Question 2: Age and Tumor Biology

**Scientific Question:** Is there a significant difference in the age of diagnosis between women with Estrogen Receptor (ER) Positive tumors vs. ER Negative tumors?

## 3.1 Visualization and Statistical Test

```{r}
# 1. Boxplot Visualization
p_age <- ggplot(df_clean, aes(x = Estrogen_Status, y = Age, fill = Estrogen_Status)) +
  geom_boxplot(alpha = 0.7) +
  geom_jitter(width = 0.2, alpha = 0.1) + # Add points to show distribution
  labs(title = "Age Distribution by Estrogen Receptor Status",
       x = "Estrogen Status", y = "Age at Diagnosis") +
  theme_minimal() +
  scale_fill_manual(values = c("red", "blue"))

print(p_age)

# 2. T-Test to compare means
t_test_result <- t.test(Age ~ Estrogen_Status, data = df_clean)

print(t_test_result)
```

**Interpretation:** 

1. Significant Age Disparity: The T-test results revealed a statistically significant difference in the mean age of diagnosis between ER-positive and ER-negative patients.

2. Clinical Implication: The boxplot visualization indicates that women with ER-Negative tumors tend to be younger at diagnosis compared to those with ER-Positive tumors. This is a critical finding, as ER-negative tumors (including Triple-Negative Breast Cancer) are often more aggressive and have fewer treatment options. The association suggests that younger breast cancer patients may require more aggressive initial screening or treatment strategies due to this unfavorable biological profile.

# 4. Research Question 3: Predictive Modeling (Machine Learning)

**Scientific Question:** Can we develop an accurate model to predict 5-year survival status using clinical variables? Does a Random Forest model outperform Logistic Regression?

## 4.1 Data Splitting

```{r}
set.seed(42) # Ensure reproducibility

# Select relevant columns for modeling
# We remove 'Survival_Months' because using it to predict Status would be data leakage
df_ml <- df_clean %>%
  select(Age, Race, Marital_Status, T_Stage, N_Stage, Stage_6th, 
         Grade, Tumor_Size, Estrogen_Status, Progesterone_Status, 
         Nodes_Examined, Nodes_Positive, Status) %>%
  na.omit() # Ensure no missing values

# Split: 70% Training, 30% Testing
trainIndex <- createDataPartition(df_ml$Status, p = 0.7, list = FALSE)
train_data <- df_ml[trainIndex, ]
test_data  <- df_ml[-trainIndex, ]

cat("Training Set Size:", nrow(train_data), "\n")
cat("Testing Set Size:", nrow(test_data), "\n")
```

## 4.2 Model Training

```{r}
# Define training control (5-fold Cross Validation)
fitControl <- trainControl(method = "cv",
                           number = 5,
                           classProbs = TRUE,
                           summaryFunction = twoClassSummary)

# Model A: Logistic Regression (Baseline)
set.seed(42)
model_glm <- train(Status ~ ., data = train_data,
                   method = "glm",
                   family = "binomial",
                   metric = "ROC",
                   trControl = fitControl)

# Model B: Random Forest (Ensemble)
set.seed(42)
model_rf <- train(Status ~ ., data = train_data,
                  method = "rf",
                  ntree = 100, # Number of trees
                  metric = "ROC",
                  trControl = fitControl)

# Compare Training Performance
results <- resamples(list(Logistic = model_glm, RandomForest = model_rf))
summary(results)
```

## 4.3 Performance Evaluation (ROC Curves & Variable Importance)

```{r}
# Predict Probabilities on Test Data
pred_prob_glm <- predict(model_glm, test_data, type = "prob")[, "Dead"]
pred_prob_rf  <- predict(model_rf, test_data, type = "prob")[, "Dead"]

# Calculate ROC Objects
roc_glm <- roc(test_data$Status, pred_prob_glm, levels = c("Alive", "Dead"))
roc_rf  <- roc(test_data$Status, pred_prob_rf, levels = c("Alive", "Dead"))

# Plot ROC Curves
plot(roc_glm, col = "blue", main = "ROC Curve Comparison: Logistic vs Random Forest")
plot(roc_rf, col = "red", add = TRUE)
legend("bottomright", 
       legend = c(paste("Logistic AUC =", round(auc(roc_glm), 3)), 
                  paste("Random Forest AUC =", round(auc(roc_rf), 3))),
       col = c("blue", "red"), lwd = 2)

# Variable Importance Plot (Random Forest)
# Helps us understand WHICH variables drive the prediction
varImpPlot(model_rf$finalModel, main = "Feature Importance (Random Forest)")

```

**Interpretation:** 

1. Model Performance: Both the Logistic Regression (linear) and Random Forest (non-linear ensemble) models achieved comparable performance, with ROC curves overlapping significantly.

2. Key Predictors: The Variable Importance plot from the Random Forest model highlighted that Number of Positive Nodes and Tumor Size are the most critical features for predicting 5-year mortality.

3. Implication: The fact that the complex Random Forest did not vastly outperform the simpler Logistic Regression suggests that the relationships between these clinical variables and survival are largely linear and robust. A simple calculator based on Node, Size, and Grade could be sufficient for clinical risk assessment in this specific context.

# 5. Research Question 4: Demographic Disparities

**Scientific Question:** Are there sociodemographic disparities in breast cancer presentation? Specifically, are unmarried women or minority racial groups more likely to be diagnosed at an Advanced Stage (Stage III)?

## 5.1 Visualization of Stage Distribution

```{r}
# Bar plot: Stage Distribution by Marital Status
p_marital <- ggplot(df_clean, aes(x = Marital_Status, fill = Is_Advanced_Stage)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Proportion of Advanced Stage by Marital Status",
       y = "Percentage", x = "Marital Status") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")

# Bar plot: Stage Distribution by Race
p_race <- ggplot(df_clean, aes(x = Race, fill = Is_Advanced_Stage)) +
  geom_bar(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Proportion of Advanced Stage by Race",
       y = "Percentage", x = "Race") +
  theme_minimal() +
  scale_fill_brewer(palette = "Set2")

grid.arrange(p_marital, p_race, ncol = 1)

```

## 5.2 Statistical Testing (Chi-Square & Odds Ratios)

We use a logistic regression to quantify the "Odds" of being diagnosed at an Advanced Stage based on demographics, controlling for Age.

```{r}
# Chi-Square Test for Marital Status vs Stage
chisq_marital <- chisq.test(table(df_clean$Marital_Status, df_clean$Is_Advanced_Stage))
print(chisq_marital)

# Logistic Regression for Odds of Advanced Stage
# Target: Is_Advanced_Stage (Advanced vs Early)
stage_logit <- glm(Is_Advanced_Stage ~ Age + Race + Marital_Status, 
                   data = df_clean, 
                   family = binomial)

# Table of Odds Ratios
tbl_regression(stage_logit, exponentiate = TRUE) %>%
  bold_p() %>%
  as_gt() %>%
  gt::tab_header(title = "Odds Ratios for Presenting with Advanced Stage (Stage III)")


```

**Interpretation:** 

1. A "Negative" Result: Contrary to our initial hypothesis, our Chi-square test and Logistic Regression analysis found no statistically significant association between Marital Status or Race and the likelihood of presenting with Advanced Stage (Stage III) disease in this specific dataset.

2. Interpretation: The Odds Ratios (OR) for race and marital status hovered near 1.0 with non-significant p-values. This suggests that in this specific SEER cohort, biological factors (like age and tumor biology) played a larger role in disease presentation than the measured sociodemographic factors. Alternatively, it implies that within this registry's population, access to initial screening (which determines stage at diagnosis) might be relatively equitable across racial and marital groups, or that the sample size for minority groups was insufficient to detect subtle disparities.


# 6. Conclusion

This comprehensive analysis of the SEER breast cancer dataset (2006-2010) integrates statistical inference with machine learning to construct a multi-dimensional view of patient prognosis.

Summary of Findings:

1. Biology Trumps Demographics: Our findings strongly suggest that clinical and biological characteristics—specifically Lymph Node Status, Tumor Stage, and Hormone Receptor Status—are the overwhelming determinants of patient survival. While sociodemographic factors are often cited in disparities research, our analysis of this specific cohort indicated that once a patient is in the system, their outcomes are primarily driven by the tumor's pathology rather than their marital status or race.

2. The "Younger-Aggressive" Phenotype: We quantified a distinct biological link where younger patients are significantly more likely to present with Estrogen-Receptor Negative tumors. This supports the need for heightened vigilance in younger women who present with breast masses, as they are statistically more likely to harbor biologically aggressive disease.

3. Predictive Feasibility: We demonstrated that standard clinical variables are highly predictive of survival outcomes. The high interpretability of our models suggests that clinical decision support tools can be effectively built using just a handful of features (Nodes, Size, Grade).

Final Thought: While this study validates the established TNM staging system, it also highlights a critical biological nuance: the intersection of age and hormone status. Future research should focus on why younger women develop these receptor-negative tumors and whether environmental or genetic factors not captured in SEER data drive this disparity. For clinical practice, the lack of demographic disparity in stage presentation is an encouraging sign of potential equity in screening within this cohort, but the aggressive biology in younger patients remains a challenge to be addressed.
